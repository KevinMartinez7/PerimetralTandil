<div class="productos-container">
  <!-- Header -->
  <header class="admin-header">
    <div class="header-content">
      <div class="header-left">
        <a routerLink="/admin/dashboard" class="back-btn">‚Üê Volver</a>
        <h1>Gesti√≥n de Productos</h1>
      </div>
      <div class="header-right">
        <button class="btn-primary" (click)="openCreateModal()">
          + Nuevo Producto
        </button>
        <button class="btn-logout" (click)="logout()">
          Cerrar Sesi√≥n
        </button>
      </div>
    </div>
  </header>

  <!-- Filtros -->
  <div class="filters-section">
    <div class="filters-content">
      <div class="filter-group">
        <input
          type="text"
          placeholder="Buscar productos..."
          [(ngModel)]="searchTerm"
          class="search-input"
        />
      </div>

      <div class="filter-group">
        <select [(ngModel)]="selectedTipo" class="filter-select">
          <option value="">Todos los tipos</option>
          <option value="cerco">Cercos Perimetrales</option>
          <option value="rural">Art√≠culos Rurales</option>
        </select>
      </div>

      <div class="filter-group">
        <select [(ngModel)]="selectedCategoria" class="filter-select">
          <option value="">Todas las categor√≠as</option>
          <option *ngFor="let cat of categorias" [value]="cat.id">
            {{ cat.nombre }}
          </option>
        </select>
      </div>
    </div>
  </div>

  <!-- Lista de Productos -->
  <div class="productos-content">
    <div class="loading-state" *ngIf="loading">
      <p>Cargando productos...</p>
    </div>

    <div class="productos-grid" *ngIf="!loading">
      <div class="producto-card" 
           *ngFor="let producto of filteredProductos"
           [class.inactive]="!producto.activo"
           [title]="!producto.activo ? 'Click para activar este producto' : ''"
           (click)="!producto.activo && toggleActivo(producto)">
        <div class="producto-image">
          <img [src]="(producto.imagenes && producto.imagenes[0]) || 'assets/no-image.png'" [alt]="producto.nombre">
          <div class="producto-status" [class.activo]="producto.activo" [class.inactivo]="!producto.activo">
            {{ producto.activo ? 'Activo' : 'Inactivo' }}
          </div>
        </div>

        <div class="producto-info">
          <h3>{{ producto.nombre }}</h3>
          <p class="producto-categoria">
            {{ producto.categoria?.nombre }} 
            <span class="tipo-badge" [class.cerco]="producto.categoria?.tipo === 'cerco'" 
                  [class.rural]="producto.categoria?.tipo === 'rural'">
              {{ producto.categoria?.tipo === 'cerco' ? 'Cerco' : 'Rural' }}
            </span>
          </p>
          <p class="producto-marca" *ngIf="producto.marca">
            Marca: {{ producto.marca.nombre }}
          </p>
          <p class="producto-descripcion">{{ producto.descripcion }}</p>
          <div class="producto-details">
            <span class="precio">${{ producto.precio | number:'1.2-2' }}</span>
            <span class="stock">Stock: {{ producto.stock }}</span>
          </div>
        </div>

        <div class="producto-actions">
          <button class="btn-edit" (click)="openEditModal(producto); $event.stopPropagation()">
            ‚úèÔ∏è Editar
          </button>
          <button class="btn-toggle" (click)="toggleActivo(producto); $event.stopPropagation()">
            {{ producto.activo ? 'üîí Desactivar' : '‚úì Activar' }}
          </button>
          <button class="btn-delete" (click)="deleteProducto(producto.id); $event.stopPropagation()">
            üóëÔ∏è Eliminar
          </button>
        </div>
      </div>

      <div class="empty-state" *ngIf="filteredProductos.length === 0">
        <p>No se encontraron productos</p>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editMode ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
        <button class="close-btn" (click)="closeModal()">√ó</button>
      </div>

      <form (ngSubmit)="saveProducto()" class="producto-form">
        <div class="form-row">
          <div class="form-group">
            <label for="nombre">Nombre *</label>
            <input
              type="text"
              id="nombre"
              [(ngModel)]="currentProducto.nombre"
              name="nombre"
              required
            />
          </div>

          <div class="form-group">
            <label for="precio">Precio *</label>
            <input
              type="number"
              id="precio"
              [(ngModel)]="currentProducto.precio"
              name="precio"
              min="0"
              step="0.01"
              required
            />
          </div>
        </div>

        <!-- Selector de Tipo de Producto -->
        <div class="form-group">
          <label for="tipoProducto">¬øD√≥nde aparecer√° este producto? *</label>
          <select
            id="tipoProducto"
            [(ngModel)]="selectedTipoProducto"
            name="tipoProducto"
            (ngModelChange)="onTipoProductoChange()"
            required
          >
            <option value="">Seleccionar secci√≥n</option>
            <option value="cerco">üè† Cercos Perimetrales (Urbano/Ciudad)</option>
            <option value="rural">üåæ Art√≠culos Rurales (Campo)</option>
          </select>
          <small *ngIf="selectedTipoProducto" class="tipo-info">
            <span *ngIf="selectedTipoProducto === 'cerco'" class="badge-cerco">
              Este producto aparecer√° en la secci√≥n de Cercos Perimetrales
            </span>
            <span *ngIf="selectedTipoProducto === 'rural'" class="badge-rural">
              Este producto aparecer√° en la secci√≥n de Art√≠culos Rurales
            </span>
          </small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="categoria">Categor√≠a *</label>
            <select
              id="categoria"
              [(ngModel)]="currentProducto.categoria"
              name="categoria"
              [disabled]="!selectedTipoProducto"
              required
            >
              <option value="">
                {{ selectedTipoProducto ? 'Seleccionar categor√≠a' : 'Primero selecciona una secci√≥n' }}
              </option>
              <option *ngFor="let cat of filteredCategorias" [value]="cat.nombre">
                {{ cat.nombre }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="marca">Marca</label>
            <select
              id="marca"
              [(ngModel)]="currentProducto.marca"
              name="marca"
            >
              <option value="">Sin marca</option>
              <option *ngFor="let marca of marcas" [value]="marca.nombre">
                {{ marca.nombre }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="stock">Stock *</label>
            <input
              type="number"
              id="stock"
              [(ngModel)]="currentProducto.stock"
              name="stock"
              min="0"
              required
            />
          </div>

          <div class="form-group">
            <label for="activo">Estado</label>
            <select
              id="activo"
              [(ngModel)]="currentProducto.activo"
              name="activo"
            >
              <option [value]="true">Activo</option>
              <option [value]="false">Inactivo</option>
            </select>
          </div>
        </div>

        <div class="form-group full-width">
          <label>Imagen del Producto</label>
          
          <!-- Drag & Drop Area -->
          <div 
            class="image-upload-area"
            [class.dragging]="isDragging"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
            (click)="fileInput.click()">
            
            <div class="upload-content" *ngIf="!imagePreview">
              <span class="upload-icon">üìÅ</span>
              <p class="upload-text">Arrastra una imagen aqu√≠</p>
              <p class="upload-subtext">o haz clic para seleccionar</p>
              <p class="upload-formats">PNG, JPG, WEBP (m√°x. 5MB)</p>
            </div>

            <div class="image-preview" *ngIf="imagePreview">
              <img [src]="imagePreview" alt="Preview">
              <button type="button" class="btn-remove-image" (click)="removeImage($event)">
                ‚úï Eliminar
              </button>
            </div>
          </div>

          <input
            #fileInput
            type="file"
            accept="image/*"
            (change)="onFileSelected($event)"
            style="display: none"
          />

          <div class="upload-progress" *ngIf="uploadProgress > 0 && uploadProgress < 100">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="uploadProgress"></div>
            </div>
            <span class="progress-text">Subiendo: {{uploadProgress}}%</span>
          </div>
        </div>

        <div class="form-group">
          <label for="descripcion">Descripci√≥n</label>
          <textarea
            id="descripcion"
            [(ngModel)]="currentProducto.descripcion"
            name="descripcion"
            rows="4"
          ></textarea>
        </div>

        <!-- Campos espec√≠ficos para CERCOS PERIMETRALES -->
        <!-- <div *ngIf="selectedTipoProducto === 'cerco'" class="cercos-fields">
          <h3 class="section-title">üè† Configuraci√≥n de Cerco Perimetral</h3>
          
          <div class="form-group">
            <label for="precio_original">Precio Original (opcional - para ofertas)</label>
            <input
              type="number"
              id="precio_original"
              [(ngModel)]="currentProducto.precio_original"
              name="precio_original"
              min="0"
              step="0.01"
              placeholder="Ej: $30,000"
            />
            <small>Si estableces un precio original, se mostrar√° el badge "¬°OFERTA!"</small>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="currentProducto.en_oferta"
                name="en_oferta"
              />
              <span>Marcar como oferta especial</span>
            </label>
          </div>

          <div class="form-group full-width">
            <label>Badges (etiquetas superiores)</label>
            <small class="field-hint">Ej: URBANO, METALPRO, PREMIUM, etc.</small>
            
            <div class="tags-input-container">
              <div class="tags-list" *ngIf="badges.length > 0">
                <span *ngFor="let badge of badges" class="tag badge-tag">
                  {{ badge }}
                  <button type="button" (click)="removeBadge(badge)" class="tag-remove">√ó</button>
                </span>
              </div>
              
              <div class="add-tag-input">
                <input
                  type="text"
                  [(ngModel)]="newBadge"
                  name="newBadge"
                  placeholder="Agregar badge..."
                  (keyup.enter)="addBadge()"
                  maxlength="20"
                />
                <button type="button" (click)="addBadge()" class="btn-add-tag">+ Agregar</button>
              </div>
            </div>
          </div>

          <div class="form-group full-width">
            <label>Caracter√≠sticas Visuales</label>
            <small class="field-hint">Ej: Altura 2m, Postes galvanizados, Malla electrosoldada, Garant√≠a 10 a√±os</small>
            
            <div class="tags-input-container">
              <div class="tags-list" *ngIf="caracteristicasVisuales.length > 0">
                <span *ngFor="let caract of caracteristicasVisuales" class="tag caracteristica-tag">
                  {{ caract }}
                  <button type="button" (click)="removeCaracteristica(caract)" class="tag-remove">√ó</button>
                </span>
              </div>
              
              <div class="add-tag-input">
                <input
                  type="text"
                  [(ngModel)]="newCaracteristica"
                  name="newCaracteristica"
                  placeholder="Agregar caracter√≠stica..."
                  (keyup.enter)="addCaracteristica()"
                />
                <button type="button" (click)="addCaracteristica()" class="btn-add-tag">+ Agregar</button>
              </div>
            </div>
          </div>
        </div> -->

        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeModal()">
            Cancelar
          </button>
          <button type="submit" class="btn-save">
            {{ editMode ? 'Actualizar' : 'Crear' }} Producto
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
